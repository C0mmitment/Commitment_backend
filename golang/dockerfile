# syntax=docker/dockerfile:1
# ↑ これを先頭に書くことでBuildKitの最新機能（キャッシュマウントなど）を有効化

# ==============================================================================
# ▼ developステージ
# ==============================================================================
FROM golang:1.23-alpine AS develop

# apkのキャッシュも活用して高速化
RUN --mount=type=cache,target=/var/cache/apk \
    apk update && apk add --no-cache git curl ca-certificates openssh

WORKDIR /usr/src/app

COPY go.mod go.sum ./
# Goモジュールキャッシュをマウント（再ダウンロード防止）
RUN --mount=type=cache,target=/go/pkg/mod \
    go mod download

COPY . .
COPY start.sh /usr/local/bin/start.sh
RUN chmod +x /usr/local/bin/start.sh

CMD ["/usr/local/bin/start.sh"]


# ==============================================================================
# ▼ builderステージ
# ==============================================================================
FROM golang:1.23-alpine AS builder

WORKDIR /usr/src/app

COPY go.mod go.sum ./

# モジュールキャッシュを使ってダウンロード
RUN --mount=type=cache,target=/go/pkg/mod \
    go mod download

COPY . .

# ビルドキャッシュ(/root/.cache/go-build)をマウントして、コンパイル時間を短縮
# -ldflags="-s -w": デバッグ情報を削除して軽量化
# -trimpath: ファイルパス情報を削除してセキュリティ向上
RUN --mount=type=cache,target=/root/.cache/go-build \
    --mount=type=cache,target=/go/pkg/mod \
    CGO_ENABLED=0 GOOS=linux go build \
    -ldflags="-s -w" \
    -trimpath \
    -o /commit-server \
    ./cmd/main.go


# ==============================================================================
# ▼ runnerステージ
# ==============================================================================
FROM gcr.io/distroless/static-debian12:nonroot AS runner

WORKDIR /usr/src/app

# バイナリをWORKDIR内に配置（パスを揃える）
COPY --from=builder /commit-server ./commit-server

USER nonroot:nonroot

# カレントディレクトリのバイナリを実行
CMD ["./commit-server"]