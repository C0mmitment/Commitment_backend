# syntax=docker/dockerfile:1

# ==============================================================================
# ▼ developステージ
# ==============================================================================
FROM --platform=linux/amd64 node:22-alpine AS develop

WORKDIR /usr/src/app

RUN npm install -g nodemon

# apkのキャッシュを活用
RUN --mount=type=cache,target=/var/cache/apk \
    apk update && apk add --no-cache git curl ca-certificates openssh

WORKDIR /usr/src/app

COPY package*.json ./
# npmのキャッシュを活用
RUN --mount=type=cache,target=/root/.npm \
    npm install

COPY . .

CMD ["nodemon"]

# ==============================================================================
# ▼ builderステージ
# package.jsonだけで node_modules を整理できます。
# ==============================================================================
FROM develop AS builder

WORKDIR /usr/src/app

# 【ここがポイント】
# JSプロジェクトならビルド不要なので、ソースコードのコピーもビルドコマンドも削除！
# ただライブラリを整理(prune)するだけ。
RUN npm prune --production


# ==============================================================================
# ▼ runnerステージ
# ==============================================================================
FROM --platform=linux/amd64 gcr.io/distroless/nodejs22-debian12 AS runner

WORKDIR /usr/src/app
ENV NODE_ENV=production

# 1. 整理された node_modules だけをもらう
COPY --from=builder --chown=nonroot:nonroot /usr/src/app ./

USER nonroot

# プロジェクトの構成に合わせてパスを指定
CMD ["app.mjs"]